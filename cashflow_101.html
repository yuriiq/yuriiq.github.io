<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Калькулятор 101</title>
</head>
<body>
    <h1>Калькулятор 101</h1>
    <form id="game-form">
        <div class="container p-name">
            <label for="p-name">Игрок:</label>
            <input type="text" id="p-name" name="p-name">
        </div>
        <div class="container" id="main-container">    
            <div class="section">
                <h2>Доходы и расходы</h2>
                <table>
                    <tr>
                        <td>Зарплата</td>
                        <td><input type="number" id="salary" name="salary"></td>
                    </tr>
                    <tr>
                        <td>Проценты/Дивиденды</td>
                        <td id="total-fond-income"></td>
                    </tr>
                    <tr>
                        <td>Недвижимость и бизнес</td>
                        <td id="total-business-income"></td>
                    </tr>
                    <tr>
                        <td>Пассивный доход</td>
                        <td id="passive-income"></td>
                    </tr>
                    <tr>
                        <td>Общий доход</td>
                        <td id="total-income"></td>
                    </tr>
                    <tr>
                        <td>Налоги</td>
                        <td><input type="number" id="taxes" name="taxes"></td>
                    </tr>
                    <tr>
                        <td>Выплаты по кредитам</td>
                        <td id="total-loan-expenses"></td>
                    </tr>
                    <tr>
                        <td>Прочие расходы</td>
                        <td><input type="number" id="other-expenses" name="other-expenses"></td>
                    </tr>
                    <tr>
                        <td>Расходы на ребёнка</td>
                        <td><input type="number" id="children" name="children"></td>
                    </tr>
                    <tr>
                        <td>
                            <div class="inline-box">
                                <input type="radio" name="children-count" id="children-count-extra" value="3">
                                <label for="children-count-extra" class="btn"> 3 </label>
                                <input type="radio" name="children-count" id="children-count-full" value="2">
                                <label for="children-count-full" class="btn"> 2 </label>
                                <input type="radio" name="children-count" id="children-count-discount" value="1">
                                <label for="children-count-discount" class="btn"> 1 </label>
                                <input type="radio" name="children-count" id="children-count-zero" value="0" checked>
                                <label for="children-count-zero" class="btn"> 0 </label>
                            </div>
                        </td>
                        <td id="children-total"></td>
                    </tr>
                    <tr>
                        <td>Общий расход</td>
                        <td id="total-expenses"></td>
                    </tr>
                    <tr>
                        <td>Месячный денежный поток</td>
                        <td id="balance"></td>
                    </tr>
                </table>
            </div>
            <div class="section">
                <h2>Кредиты</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Назначение</th>
                            <th>Тело</th>
                            <th>Ставка</th>
                            <th>Платеж</th>
                        </tr>
                    </thead>
                    <tbody id="loan-table">
                        <tr>
                            <td>Ипотека</td>
                            <td><input type="number" class="lender-loan" name="lender-loan0"></td>
                            <td class="loan-rate"></td>
                            <td><input type="number" class="lender-payment" name="lender-payment0" manual></td>
                        </tr>
                        <tr>
                            <td>Образование</td>
                            <td><input type="number" class="lender-loan" name="lender-loan1"></td>
                            <td class="loan-rate"></td>
                            <td><input type="number" class="lender-payment" name="lender-payment1" manual></td>
                        </tr>
                        <tr>
                            <td>Авто</td>
                            <td><input type="number" class="lender-loan" name="lender-loan2"></td>
                            <td class="loan-rate"></td>
                            <td><input type="number" class="lender-payment" name="lender-payment2" manual></td>
                        </tr>
                        <tr>
                            <td>Карта</td>
                            <td><input type="number" class="lender-loan" name="lender-loan3"></td>
                            <td class="loan-rate"></td>
                            <td><input type="number" class="lender-payment" name="lender-payment3" manual></td>
                        </tr>
                        <tr>
                            <td>Кредиты</td>
                            <td><input type="number" class="lender-loan" name="lender-loan4"></td>
                            <td class="loan-rate"></td>
                            <td><input type="number" class="lender-payment" name="lender-payment4" manual></td>
                        </tr>
                        <tr id="add-loan">
                            <td colspan="3"><button type="button" onclick="addNewLoan()">Добавить новый кредит</button></td>
                            <td><input type="hidden" id="total-loan-counter" name="total-loan-counter" readonly></td>
                        </tr>
                        <tr id="total-loan-row">
                            <td colspan="3">Итого расходов по кредитам:</td>
                            <td id="loan-expenses"></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="section">
                <h2>Акции и фонды</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Название</th>
                            <th>Количество</th>
                            <th>Цена</th>
                            <th>Доход</th>
                            <th>Всего</th>
                        </tr>
                    </thead>
                    <tbody id="fond-table">
                        <tr id="add-fond">
                            <td colspan="4"><button type="button" onclick="addNewFond()">Добавить новый актив</button></td>
                            <td><input type="hidden" id="total-fond-counter" name="total-fond-counter" readonly></td>
                        </tr>
                        <tr id="total-fond-row">
                            <td colspan="4"><label for="total-fond">Итого доходов по всем активам:</label></td>
                            <td><input type="number" id="total-fond" name="total-fond" readonly disabled></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="section">
                <h2>Недвижимость и бизнес</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Название</th>
                            <th>Взнос</th>
                            <th>Цена</th>
                            <th>Пассив</th>
                            <th>Доход</th>
                        </tr>
                    </thead>
                    <tbody id="business-table">
                        <tr id="add-business">
                            <td colspan="4"><button type="button" onclick="addNewBusiness()">Добавить новый актив</button></td>
                            <td><input type="hidden" id="total-business-counter" name="total-business-counter" readonly></td>
                        </tr>
                        <tr id="total-business-row">
                            <td colspan="4"><label for="total-business">Итого доходов по всем активам:</label></td>
                            <td><input type="number" id="total-business" name="total-business" readonly disabled></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="container">
            <p id="goal_ok">Цель достигнута!</p>
            <button id="clear-cache" type="reset">Очистить всё</button>
        </div>
    </form>
</body>
<script>
    const incomeTableBody = document.getElementById('income-table')
    const loanTableBody = document.getElementById('loan-table')
    const fondTableBody = document.getElementById('fond-table')
    const businessTableBody = document.getElementById('business-table')
    const trainingTableBody = document.getElementById('training-table')

    function saveFormData() {
        const form = document.getElementById('game-form')
        const formData = new FormData(form)
        const data = {}
        formData.forEach((value, key) => {
            data[key] = value
        })
        localStorage.setItem('formData', JSON.stringify(data))
    }
    
    function loadFormData() {
        const formData = JSON.parse(localStorage.getItem('formData'))
        if (formData) {
            createNewLoanRows(formData['total-loan-counter'])
            createNewFondRows(formData['total-fond-counter']) 
            createNewBusinessRows(formData['total-business-counter']) 
            for (const key in formData) {
                const elements = document.getElementsByName(key)
                console.log(key, elements.length)
                for (i = 0; i < elements.length; ++i) {
                    const element = elements[i]
                    if (element) {
                        if (element.type === 'radio' || element.type === 'checkbox') {
                            if (element.value === formData[key]) {
                                element.checked = true
                            }
                        } else {
                            element.value = formData[key]
                        }
                    }
                }
            }
        }
    }

    function addNewLoan() {
        const newRow = document.createElement('tr');
        //
        const nameCell = document.createElement('td')
        const inputName = document.createElement('input')
        inputName.type = 'text'
        inputName.name = 'loan-name' + loanTableBody.rows.length
        nameCell.appendChild(inputName)
        newRow.appendChild(nameCell)  
        //
        const inputCell = document.createElement('td')
        const inputTitle = document.createElement('input')
        inputTitle.type = 'number'
        inputTitle.className = 'lender-loan'
        inputTitle.name = 'lender-loan' + loanTableBody.rows.length
        inputCell.appendChild(inputTitle)
        newRow.appendChild(inputCell)
        //
        const annualCell = document.createElement('td')
        annualCell.innerHTML = '10%'
        annualCell.className = 'loan-rate'
        newRow.appendChild(annualCell)
        //
        const outputCell = document.createElement('td')
        const inputPayment = document.createElement('input')
        inputPayment.type = 'number'
        inputPayment.disabled = true
        inputPayment.readOnly = true
        inputPayment.className = 'lender-payment'
        inputPayment.name = 'lender-payment' + loanTableBody.rows.length
        outputCell.appendChild(inputPayment)
        newRow.appendChild(outputCell)
        loanTableBody.appendChild(newRow)
        //
        loanTableBody.appendChild(document.getElementById('add-loan'))
        loanTableBody.appendChild(document.getElementById('total-loan-row'))
    }

    function addNewFond() {
        const newRow = document.createElement('tr');
        //
        const nameCell = document.createElement('td')
        const inputName = document.createElement('input')
        inputName.type = 'text'
        inputName.name = 'fond-name' + fondTableBody.rows.length
        nameCell.appendChild(inputName)
        newRow.appendChild(nameCell)  
        //
        const countCell = document.createElement('td')
        const inputCount = document.createElement('input')
        inputCount.type = 'number'
        inputCount.className = 'fond-count'
        inputCount.name = 'fond-count' + fondTableBody.rows.length
        countCell.appendChild(inputCount)
        newRow.appendChild(countCell)
        //
        const priceCell = document.createElement('td')
        const inputPrice = document.createElement('input')
        inputPrice.type = 'number'
        inputPrice.className = 'fond-price'
        inputPrice.name = 'fond-price' + fondTableBody.rows.length
        priceCell.appendChild(inputPrice)
        newRow.appendChild(priceCell)
        //
        const incomeCell = document.createElement('td')
        const inputIncome = document.createElement('input')
        inputIncome.type = 'number'
        inputIncome.className = 'fond-income'
        inputIncome.name = 'fond-income' + fondTableBody.rows.length
        incomeCell.appendChild(inputIncome)
        newRow.appendChild(incomeCell)
        //
        const totalCell = document.createElement('td')
        const inputTotal = document.createElement('input')
        inputTotal.type = 'number'
        inputTotal.className = 'fond-total'
        inputTotal.disabled = true
        inputTotal.readOnly = true 
        inputTotal.name = 'fond-total' + fondTableBody.rows.length
        totalCell.appendChild(inputTotal)
        newRow.appendChild(totalCell)
        //
        fondTableBody.appendChild(newRow)
        //
        fondTableBody.appendChild(document.getElementById('add-fond'))
        fondTableBody.appendChild(document.getElementById('total-fond-row'))
    }

    function addNewBusiness() {
        const newRow = document.createElement('tr');
        //
        const nameCell = document.createElement('td')
        const inputName = document.createElement('input')
        inputName.type = 'text'
        inputName.name = 'business-name' + businessTableBody.rows.length
        nameCell.appendChild(inputName)
        newRow.appendChild(nameCell)  
        //
        const totalCell = document.createElement('td')
        const inputTotal = document.createElement('input')
        inputTotal.type = 'number' 
        inputTotal.name = 'business-initial' + businessTableBody.rows.length
        totalCell.appendChild(inputTotal)
        newRow.appendChild(totalCell)
        //
        const countCell = document.createElement('td')
        const inputCount = document.createElement('input')
        inputCount.type = 'number'
        inputCount.name = 'business-credit' + businessTableBody.rows.length
        countCell.appendChild(inputCount)
        newRow.appendChild(countCell)
        //
        const priceCell = document.createElement('td')
        const inputPrice = document.createElement('input')
        inputPrice.type = 'number'
        inputPrice.name = 'business-price' + businessTableBody.rows.length
        priceCell.appendChild(inputPrice)
        newRow.appendChild(priceCell)
        //
        const incomeCell = document.createElement('td')
        const inputIncome = document.createElement('input')
        inputIncome.type = 'number'
        inputIncome.className = 'business-income'
        inputIncome.name = 'business-income' + businessTableBody.rows.length
        incomeCell.appendChild(inputIncome)
        newRow.appendChild(incomeCell)
        //
        businessTableBody.appendChild(newRow)
        //
        businessTableBody.appendChild(document.getElementById('add-business'))
        businessTableBody.appendChild(document.getElementById('total-business-row'))
    }

    function createNewLoanRows(maximum) {
        for (i = loanTableBody.rows.length; i <= maximum; ++i) {
            addNewLoan()
        }
    }

    function createNewFondRows(maximum) {
        for (i = fondTableBody.rows.length; i <= maximum; ++i) {
            addNewFond()
        }
    }

    function createNewBusinessRows(maximum) {
        for (i = businessTableBody.rows.length; i <= maximum; ++i) {
            addNewBusiness()
        }
    }

    function getSelectedValue(name) {
        const element = document.getElementsByName(name)
        for (i = 0, length = element.length; i < length; i++) {
            if (element[i].checked) {
                return element[i].value
            }
        }
    }

    function calculateLoans() {
        //
        const lenderLoans = document.getElementsByClassName('lender-loan')
        const lenderPayments = document.getElementsByClassName('lender-payment')
        const loanRates = document.getElementsByClassName('loan-rate')
        let totalLoan = 0 
        if (lenderLoans.length == lenderPayments.length && lenderPayments.length == loanRates.length) {
            for (i = 0; i < lenderLoans.length; ++i) {
                const lenderLoan = parseFloat(lenderLoans[i].value) || 0
                if (lenderPayments[i].hasAttribute('manual')) {
                    const lenderPayment = parseFloat(lenderPayments[i].value) || 0
                    if (lenderLoan == 0) {
                        loanRates[i].innerHTML = '---'
                    } else {
                        loanRates[i].innerHTML = Math.round(lenderPayment / lenderLoan * 100) + "%"
                    }
                    totalLoan += lenderPayment
                } else {
                    const loanRate = parseFloat(loanRates[i].innerHTML) || 0
                    const final = lenderLoan * loanRate * 0.01
                    lenderPayments[i].value = final.toFixed(2)
                    totalLoan += final
                }
            }
        } else {
            throw new Error("Wrong table scruct")
        }
        document.getElementById("loan-expenses").innerHTML = totalLoan.toFixed(2)
        document.getElementById("total-loan-expenses").innerHTML = totalLoan.toFixed(2)
        document.getElementById("total-loan-counter").value = loanTableBody.rows.length - 1
        return totalLoan
    }

    function calculateFonds() {
        const fondCounts = document.getElementsByClassName('fond-count')
        const fondPrices = document.getElementsByClassName('fond-price')
        const fondIncomes = document.getElementsByClassName('fond-income')
        const fondTotals = document.getElementsByClassName('fond-total')
        
        let totalFonds = 0 
        if (fondCounts.length == fondPrices.length && fondPrices.length == fondIncomes.length && fondIncomes.length == fondTotals.length) {
            for (i = 0; i < fondCounts.length; ++i) {
                const fondCount = parseFloat(fondCounts[i].value) || 0
                const fondIncome = parseFloat(fondIncomes[i].value) || 0
                const fondTotal = fondCount * fondIncome
                totalFonds += fondTotal
                fondTotals[i].value = fondTotal.toFixed(2)
            }
        } else {
            throw new Error("Wrong table scruct")
        }
        document.getElementById("total-fond").value = totalFonds.toFixed(2)
        document.getElementById("total-fond-income").innerHTML = totalFonds.toFixed(2)
        document.getElementById("total-fond-counter").value = fondTableBody.rows.length - 1
        return totalFonds
    }

    function calculateBusiness() {
        const businessIncome = document.getElementsByClassName('business-income')        
        let totalFonds = 0 
        for (i = 0; i < businessIncome.length; ++i) {
            totalFonds += parseFloat(businessIncome[i].value) || 0
        }

        document.getElementById("total-business").value = totalFonds.toFixed(2)
        document.getElementById("total-business-income").innerHTML = totalFonds.toFixed(2)
        document.getElementById("total-business-counter").value = businessTableBody.rows.length - 1
        return totalFonds
    }

    function calculateExpenses(totalBusiness, totalFond, totalLoan) {
        const salary = parseFloat(document.getElementById("salary").value) || 0
        const otherExpenses = parseFloat(document.getElementById("other-expenses").value) || 0
        const taxes = parseFloat(document.getElementById("taxes").value) || 0
        const baseChildren = parseFloat(document.getElementById("children").value) || 0
        const children = baseChildren  * parseFloat(getSelectedValue("children-count")) || 0
        const totalLifeExpenses = children + taxes + otherExpenses
        const totalExpenses = totalLifeExpenses + totalLoan
        const passiveIncome = totalBusiness + totalFond
        const totalIncome = passiveIncome + salary
        const balance = totalIncome - totalExpenses
        //
        document.getElementById("children-total").innerHTML = children.toFixed(2)
        document.getElementById("passive-income").innerHTML = passiveIncome.toFixed(2)
        document.getElementById("total-income").innerHTML = totalIncome.toFixed(2)
        document.getElementById("total-expenses").innerHTML = totalExpenses.toFixed(2)
        //
        const balanceElement = document.getElementById("balance")
        balanceElement.innerHTML = balance.toFixed(2)
        if (totalIncome < totalExpenses) {
            balanceElement.classList.add('negative')
        } else {
            balanceElement.classList.remove('negative')
        }
        //
        if (passiveIncome > totalExpenses) {
            document.getElementById('goal_ok').style.display = "block";
            document.getElementById('main-container').style.background = "#c1e0c1";
        } else {
            document.getElementById('goal_ok').style.display = "none"; 
            document.getElementById('main-container').style.background = "#fff";
        }
        document.title = document.getElementById("p-name").value
    }

    function calculateTotals() {
        const loans = calculateLoans()
        const fonds = calculateFonds()
        const business =  calculateBusiness()
        calculateExpenses(business, fonds, loans)
    }

    window.onload = function() {
        loadFormData()
        calculateTotals()
    }

    document.getElementById('clear-cache').addEventListener('click', function() {
        localStorage.clear()
        location.reload()
    })

    document.getElementById("game-form").addEventListener("input", event => {
        calculateTotals()
        saveFormData()
    })
</script>
<style>
    body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f4f4f4;
    }
    .container {
        min-width: 535px;
        margin: 10px;
        padding: 10px;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }
    #goal_ok {
        color: #700070;
        font-size: x-large;
        display: none;
    }
    #main-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
    }
    h1 {
        text-align: center;
    }
    .section {
        width: 535px;
        margin-bottom: 20px;
        padding: 2px;
    }
    .section h2 {
        border-bottom: 2px solid #ddd;
        padding-bottom: 10px;
    }
    .expense-category h3 {
        margin-bottom: 10px;
    }
    label {
        margin: 5px 0;
    }
    #p-name {
        width: 100%;
    }
    #main-container input[type="text"] {
        width: 70px;
    }
    input[type="text"] {
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;        
    }
    input[type="number"] {
        width: 60px;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    input[type="radio"] {
        display: none;
    }
    input[type="radio"] label {
        padding: 5px;
        cursor: pointer;
        appearance: button;
    }
    input[type="radio"]:checked + label {
        background-color: #007bff;
        color: #fff;
        border-color: #007bff;
    }
    input[type="checkbox"] {
        appearance: none;
        min-width: 20px;
        min-height: 20px;
        height: 100%;
        width: height;
        background-color: #ccc;
        border: none;
        cursor: pointer;
        outline: none;
    }
    input[type="checkbox"]:checked {
        background-color: #007bff;
    }
    select {
        width: 60px;
    }
    label.btn {
        display: inline-block;
        min-width: 30px;
        padding: 5px 5px;
        margin: 0 5px;
        border: 1px solid #ccc;
        border-radius: 4px;
        cursor: pointer;
        background-color: #f8f8f8;
        transition: background-color 0.3s;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 10px;
    }
    table, th, td {
        border: 1px solid #ddd;
    }
    th, td {
        padding: 10px;
        text-align: center;
    }
    .p-name {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .p-name label {
        flex: 1;
    }
    .p-name input {
        flex: 2;
    }
    .inline {
        display: inline;
    }
    #status {
        display: block;
        margin-bottom: 20px;
    }
    #balance {
        font-size: x-large;
    }
    #clear-cache {
        width: 100%;
        height: 100%;
    }
    .negative {
        color:red;
    }
    .inline-box {
        display: inline-flex;
    }
</style>
</html>
